jQuery(function(R){"use strict";var c=R(document).find(".ywarc_new_rules"),A=R(document).find(".ywarc_rules_group"),a=R("#yith_ywarc_add_rule_button"),l=R(".ywarc_new_rule_title"),r=R(".ywarc_creating_rule");function t(e,m){var w=R(e),h=w.data("rule_id"),e=w.find(".rule_head"),v=w.find(".rule_options"),g=e.find("label.rule_title").text();m&&(c.append(w),v.show(),B()),e.on("click",function(e){v.slideToggle()}),w.trigger("init_tooltips");var k=v.find("div.rule_type_block"),b=v.find("div.role_selector_block");b.hide();var j=v.find("div.replace_role_block");j.hide();var D=v.find("div.rule_radio_group");D.hide();var C=v.find("div.specific_product_block");C.hide();var z=v.find("div.specific_range_block");z.hide();var x=v.find("div.specific_taxonomy_block");x.hide();var S=x.find("div.category_search_block");S.hide();var F=x.find("div.tag_search_block");F.hide();var a=v.find("div.date_range_block");a.hide();var l=v.find("div.duration_block");l.hide();var I=v.find("div.role_filter_selector_block");I.hide();var r=v.find("div.submit_block");r.hide();var M=z.find('input[name="price_range_from"]'),L=z.find('input[name="price_range_to"]'),T=a.find(".sale_price_dates_from"),q=a.find(".sale_price_dates_to"),O=l.find(".ywarc_duration"),t=function(e){"role_selector"!=e&&"all"!=e||(b.removeClass("empty_field"),j.removeClass("empty_field")),"product_selector"!=e&&"all"!=e||C.removeClass("empty_field"),"price_range"!=e&&"all"!=e||(z.removeClass("empty_field"),z.removeClass("ywarc_from_gt_to")),"category"!=e&&"all"!=e||(S.removeClass("empty_field"),x.removeClass("empty_field")),"tag"!=e&&"all"!=e||(F.removeClass("empty_field"),x.removeClass("empty_field"))};M.on("change",function(){t("price_range")}),L.on("change",function(){t("price_range")}),v.find(".sale_price_dates_fields").each(function(){var r=R(this).find("input").datepicker({defaultDate:"",dateFormat:"yy-mm-dd",numberOfMonths:1,showButtonPanel:!0,onSelect:function(e){var a=R(this).is(".sale_price_dates_from")?"minDate":"maxDate",l=R(this).data("datepicker"),l=R.datepicker.parseDate(l.settings.dateFormat||R.datepicker._defaults.dateFormat,e,l.settings);r.not(this).datepicker("option",a,l)}})}),v.find("input.ywarc_rule_type_radio_button").change(function(){var e=v.find("input.ywarc_rule_type_radio_button:checked");"add"==e.val()?(j.hide(),b.slideDown(),D.show()):"replace"==e.val()&&(j.slideDown(),b.hide(),D.show())}).change(),v.find("input.ywarc_rule_radio_button").change(function(){t("all");var e=v.find("input.ywarc_rule_radio_button:checked");"product"==e.val()?(z.hide(),x.hide(),C.slideDown(),a.slideDown(),l.slideDown(),I.slideDown(),r.slideDown()):"range"==e.val()||"overall"==e.val()?(C.hide(),x.hide(),z.slideDown(),a.slideDown(),l.slideDown(),I.slideDown(),r.slideDown()):"taxonomy"==e.val()&&(C.hide(),z.hide(),x.slideDown(),a.slideDown(),l.slideDown(),I.slideDown(),r.slideDown())}).change(),x.find("input.ywarc_tax_radio_button").change(function(){t("all");var e=x.find("input.ywarc_tax_radio_button:checked");"category"==e.val()?(F.hide(),S.show()):"tag"==e.val()&&(S.hide(),F.show())}).change(),e=localize_js_ywarc_admin.before_2_7?{maximumSelectionSize:1}:{maximumSelectionLength:1},v.find(".ywarc_role_selector, .ywarc_replace_role_before, .ywarc_replace_role_after").select2(e).on("change",function(){t("role_selector")}),I.find(".role_filter_selector").select2(),R(document.body).trigger("wc-enhanced-select-init"),R(":input.wc-product-search").on("change",function(){t("product_selector")});var i=function(e){var l=[];return e&&R.each(e,function(e,a){l.push({id:e,text:a})}),{results:l}},_=function(e,a){var l=R.parseJSON(e.attr("data-selected")),r=[];return R(e.val().split(",")).each(function(e,a){r.push({id:a,text:l[a]})}),a(r)},n=function(e){return'<div class="selected-option" data-id="'+e.id+'">'+e.text+"</div>"};R(":input.ywarc-category-search").filter(":not(.enhanced)").each(function(){var e={url:localize_js_ywarc_admin.ajax_url,dataType:"json",quietMillis:250,data:function(e){return{term:e,action:"ywarc_category_search",security:localize_js_ywarc_admin.search_categories_nonce}},cache:!0};localize_js_ywarc_admin.before_2_7?e.results=i:e.processResults=i;e={initSelection:localize_js_ywarc_admin.before_2_7?_:null,formatSelection:localize_js_ywarc_admin.before_2_7?n:null,multiple:R(this).data("multiple"),allowClear:!!R(this).data("allow_clear"),placeholder:R(this).data("placeholder"),minimumInputLength:R(this).data("minimum_input_length")?R(this).data("minimum_input_length"):"3",escapeMarkup:function(e){return e},ajax:e};R(this).select2(e).addClass("enhanced").on("change",function(){t("category")})}),R(":input.ywarc-tag-search").filter(":not(.enhanced)").each(function(){var e={url:localize_js_ywarc_admin.ajax_url,dataType:"json",quietMillis:250,data:function(e){return{term:e,action:"ywarc_tag_search",security:localize_js_ywarc_admin.search_tags_nonce}},cache:!0};localize_js_ywarc_admin.before_2_7?e.results=i:e.processResults=i;e={initSelection:localize_js_ywarc_admin.before_2_7?_:null,formatSelection:localize_js_ywarc_admin.before_2_7?n:null,multiple:R(this).data("multiple"),allowClear:!!R(this).data("allow_clear"),placeholder:R(this).data("placeholder"),minimumInputLength:R(this).data("minimum_input_length")?R(this).data("minimum_input_length"):"3",escapeMarkup:function(e){return e},ajax:e};R(this).select2(e).addClass("enhanced").on("change",function(){t("tag")})}),r.find("input").on("click",function(e){e.preventDefault(),w.block({message:null,overlayCSS:{background:"#fff",opacity:.6}});var a=k.find("input.ywarc_rule_type_radio_button:checked").val(),l=b.find("select.ywarc_role_selector").val(),r=j.find("select.ywarc_replace_role_before").val(),t=j.find("select.ywarc_replace_role_after").val(),i=v.find("input.ywarc_rule_radio_button:checked").val(),_=C.find(':input[id^="ywarc_product_selector"]').val(),n=M.val(),c=L.val(),o=x.find("input.ywarc_tax_radio_button:checked").val(),d=S.find(':input[id^="ywarc_category_selector"]').val(),s=F.find(':input[id^="ywarc_tag_selector"]').val(),u=T.val(),f=q.val(),p=O.val(),y=I.find("select.role_filter_selector").val(),e=!0;"add"==a?l||(e=!1,b.addClass("empty_field")):"replace"==a?r&&t||(e=!1,j.addClass("empty_field")):(e=!1,k.addClass("empty_field")),"product"==i?_||(e=!1,C.addClass("empty_field")):"range"==i||"overall"==i?(n||c||(e=!1,z.addClass("empty_field")),c&&parseInt(n)>=parseInt(c)&&(e=!1,z.addClass("ywarc_from_gt_to"))):"taxonomy"==i?"category"==o?d||(e=!1,S.addClass("empty_field")):"tag"==o?s||(e=!1,F.addClass("empty_field")):(e=!1,x.addClass("empty_field")):(e=!1,D.addClass("empty_field")),e?(p=0<(p=parseInt(p,10))?p:"",R.post(localize_js_ywarc_admin.ajax_url,{action:"ywarc_save_rule",title:g,rule_id:h,rule_type:a,role_selected:l||"",replace_roles:r&&t?[r,t]:"",radio_group:i,product_selected:"product"===i?_:"",price_range_from:"range"===i||"overall"===i?n:"",price_range_to:"range"===i||"overall"===i?c:"",tax_radio_group:"taxonomy"===i?o:"",categories_selected:"taxonomy"===i&&"category"===o?d:"",tags_selected:"taxonomy"===i&&"tag"===o?s:"",date_from:u,date_to:f,duration:p,role_filter:y},function(e){w.unblock(),m&&(A.append(w),v.hide(),m=!1),0<A.find(".rule_block").length&&R("#my_rules_header").removeClass("no_rules"),B()})):w.unblock(),B()}),r.find("a.delete_rule").on("click",function(e){e.preventDefault(),1==confirm(localize_js_ywarc_admin.delete_rule_msg)&&(m?w.remove():(w.block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),R.post(localize_js_ywarc_admin.ajax_url,{action:"ywarc_delete_rule",rule_id:h},function(e){w.unblock(),w.remove(),0==A.find(".rule_block").length&&R("#my_rules_header").addClass("no_rules")})),0==A.find(".rule_block").length&&R("#my_rules_header").addClass("no_rules")),B()})}function B(){0<c.find(".rule_block").length?R("#ywarc_new_rules_row").removeClass("no_rules"):R("#ywarc_new_rules_row").addClass("no_rules")}l.focus(),l.keydown(function(e){13==e.which&&(a.focus(),a.trigger("click"))}),a.on("click",function(e){e.preventDefault();var e=l.val().trim(),a=[];c.find(".rule_title").each(function(){a.push(R(this).text())}),"-1"!=R.inArray(e,a)?(alert(localize_js_ywarc_admin.duplicated_name_msg),l.val(""),l.focus()):""==e?(alert(localize_js_ywarc_admin.empty_name_msg),l.focus()):(r.block({message:null,overlayCSS:{background:"#f1f1f1",opacity:.6}}),R.post(localize_js_ywarc_admin.ajax_url,{action:"ywarc_add_rule",title:e},function(e){r.unblock(),l.val(""),"duplicated_name_error"===e?(alert(localize_js_ywarc_admin.duplicated_name_msg),l.focus()):t(e,!0)}))}),R(".rule_block").each(function(e,a){t(a,!1)}),R("#show_all_rules").on("click",function(e){e.preventDefault(),A.find(".rule_options").slideDown()}),R("#hide_all_rules").on("click",function(e){e.preventDefault(),A.find(".rule_options").slideUp()}),R("#delete_all_rules").on("click",function(e){e.preventDefault(),1==confirm(localize_js_ywarc_admin.delete_all_rules_msg)&&(r.block({message:null,overlayCSS:{background:"#f1f1f1",opacity:.6}}),R.post(localize_js_ywarc_admin.ajax_url,{action:"ywarc_delete_all_rules"},function(e){r.unblock(),A.find(".rule_block").remove(),R("#my_rules_header").addClass("no_rules")})),B()}),R("#ywarc_force_apply_rules_set_dates_button").on("click",function(e){e.preventDefault(),R(".ywarc_force_apply_rules_dates").toggle(400)});var _=R("#ywarc_force_apply_rules_from_date").datepicker({defaultDate:"",dateFormat:"yy-mm-dd",maxDate:0}),n=R("#ywarc_force_apply_rules_to_date").datepicker({defaultDate:"",dateFormat:"yy-mm-dd",maxDate:0});_.datepicker("option","onSelect",function(e){n.datepicker("option","minDate",e)}),n.datepicker("option","onSelect",function(e){_.datepicker("option","maxDate",e)}),R("#ywarc_force_apply_rules").on("click",function(e){e.preventDefault();var a,l,r,t="none"===R(".ywarc_force_apply_rules_dates").css("display"),i=localize_js_ywarc_admin.force_apply_rules_warning+" ",e={action:"ywarc_force_apply_rules",security:localize_js_ywarc_admin.force_apply_rules_nonce,ywarc_find_all_orders:t?"1":"0"};t?i+=localize_js_ywarc_admin.force_apply_all_rules:(t=R("[name='ywarc_force_apply_rules_set_date_type']:checked").val(),a=_.val()?_.val():"",l=n.val()?n.val():"",e.ywarc_date_type=t,e.ywarc_from=a,e.ywarc_to=l,a||l?a&&l?i+=localize_js_ywarc_admin.force_apply_date_range_rules:a&&!l?i+=localize_js_ywarc_admin.force_apply_date_from_rules:!a&&l&&(i+=localize_js_ywarc_admin.force_apply_date_to_rules):i+=localize_js_ywarc_admin.force_apply_all_rules,i=(i=i.replace("{date_from}",a)).replace("{date_to}",l)),a&&l&&l<a?alert(localize_js_ywarc_admin.force_apply_rules_dates_warning):window.confirm(i)&&((r=R("span.ywarc_creating_rule.ywarc_force_apply_rules_row")).block({message:null,overlayCSS:{background:"#f1f1f1",opacity:.6}}),R.post(localize_js_ywarc_admin.ajax_url,e,function(e){e.success||"from_date_gt_to_date_error"!==e.data||alert(localize_js_ywarc_admin.force_apply_rules_dates_warning),r.unblock()}))})});